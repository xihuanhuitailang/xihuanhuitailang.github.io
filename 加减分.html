<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç™½&é¸¡æ¯› æ‹çˆ±åŠ å‡åˆ†å™¨ ğŸ’• åŒå‘å¥”èµ´å…¨åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background-color: #fef6f9;
            color: #333;
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
        }
        .container {
            background: #fff;
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 0 20px rgba(255, 148, 166, 0.1);
        }
        h1 {
            text-align: center;
            color: #ff6b8b;
            font-size: 24px;
            margin-bottom: 30px;
        }
        /* åˆ†æ•°å±•ç¤ºåŒº-å¸¦å¤´åƒ */
        .score-card {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 15px;
        }
        .person {
            text-align: center;
            flex: 1;
            background: #fdf2f5;
            padding: 20px 15px;
            border-radius: 15px;
            position: relative;
        }
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            object-fit: cover;
            border: 3px solid #ff9eb1;
        }
        .person h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #555;
        }
        .score {
            font-size: 36px;
            font-weight: bold;
            color: #ff6b8b;
            transition: color 0.3s;
        }
        .score.low {
            color: #ffb84d;
        }
        .score.very-low {
            color: #ff7f7f;
        }
        /* çºªå¿µæ—¥è§’æ ‡ */
        .anniversary-tag {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff6b8b;
            color: #fff;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            display: none;
        }
        .anniversary-tag.show {
            display: block;
        }
        /* æ“ä½œåŒº-è‡ªå®šä¹‰åŠ å‡åˆ†+æ ‡ç­¾+æ‚„æ‚„è¯ */
        .operate {
            margin-bottom: 30px;
        }
        .operate h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #555;
            border-left: 4px solid #ff6b8b;
            padding-left: 10px;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .form-item label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        .select-person, .score-select, .tag-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            color: #333;
            background: #fff;
        }
        .score-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .score-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fff;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        .score-btn.active {
            background: #ff6b8b;
            color: #fff;
            border: none;
        }
        .reason, .whisper {
            width: 100%;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            resize: none;
            color: #333;
            transition: border 0.3s;
        }
        .reason {
            height: 80px;
        }
        .whisper {
            height: 60px;
        }
        .reason:focus, .whisper:focus {
            outline: none;
            border: 1px solid #ff9eb1;
        }
        .tip {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .btn-wrap {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .confirm-btn, .export-btn, .anniversary-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .confirm-btn {
            flex: 2;
            background: #ffc2d1;
            color: #fff;
            cursor: not-allowed;
        }
        .confirm-btn.able {
            background: #ff6b8b;
            cursor: pointer;
        }
        .export-btn, .anniversary-btn {
            flex: 1;
            background: #fdf2f5;
            color: #ff6b8b;
        }
        .export-btn:hover, .anniversary-btn:hover {
            background: #ff6b8b;
            color: #fff;
        }
        /* åˆ†æ•°ç»Ÿè®¡+è¶‹åŠ¿å›¾åŒº */
        .stat {
            margin-bottom: 30px;
        }
        .stat h3, .trend h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #555;
            border-left: 4px solid #ff6b8b;
            padding-left: 10px;
        }
        .stat-card {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            flex: 1;
            background: #fdf2f5;
            padding: 15px;
            border-radius: 10px;
        }
        .stat-item p {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-num {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b8b;
        }
        .trend {
            margin-bottom: 30px;
        }
        .chart-wrap {
            width: 100%;
            height: 250px;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            background: #fff;
        }
        /* è®°å½•åŒº-å¤šç­›é€‰+æ‚„æ‚„è¯+çºªå¿µæ—¥æ ‡è®° */
        .record {
            margin-bottom: 20px;
        }
        .record h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #555;
            border-left: 4px solid #ff6b8b;
            padding-left: 10px;
        }
        .record-top-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .filter, .tag-filter {
            display: flex;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }
        .filter-btn, .tag-filter-btn {
            padding: 6px 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fff;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .filter-btn.active, .tag-filter-btn.active {
            background: #ff6b8b;
            color: #fff;
            border: none;
        }
        .record-count {
            font-size: 14px;
            color: #999;
            line-height: 30px;
        }
        .clear-btn {
            padding: 6px 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fff;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .clear-btn:hover {
            border-color: #ff6b8b;
            color: #ff6b8b;
        }
        .record-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
        }
        .record-item {
            padding: 15px;
            border-bottom: 1px solid #f5f5f5;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            position: relative;
        }
        .record-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        /* çºªå¿µæ—¥è®°å½•è§’æ ‡ */
        .record-anni-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 16px;
            height: 16px;
            background: url("data:image/svg+xml,%3Csvg t='1737320000000' class='icon' viewBox='0 0 1024 1024' version='1.1' xmlns='http://www.w3.org/2000/svg' p-id='2874' xmlns:xlink='http://www.w3.org/1999/xlink' width='16' height='16'%3E%3Cpath d='M512 896c-212.096 0-384-171.904-384-384s171.904-384 384-384 384 171.904 384 384-171.904 384-384 384z m0-704c-176.448 0-320 143.552-320 320s143.552 320 320 320 320-143.552 320-320-143.552-320-320-320z' fill='%23ff6b8b' p-id='2875'%3E%3C/path%3E%3Cpath d='M512 416c-52.896 0-96 43.104-96 96s43.104 96 96 96 96-43.104 96-96-43.104-96-96-96z m0 128c-17.632 0-32-14.368-32-32s14.368-32 32-32 32 14.368 32 32-14.368 32-32 32z' fill='%23ff6b8b' p-id='2876'%3E%3C/path%3E%3C/svg%3E") no-repeat center;
            display: none;
        }
        .record-anni-tag.show {
            display: block;
        }
        .record-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .record-name {
            font-weight: bold;
            color: #ff6b8b;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .record-score {
            font-weight: bold;
            font-size: 18px;
        }
        .record-score.add1 {
            color: #ff6b8b;
        }
        .record-score.add2 {
            color: #ff477e;
        }
        .record-score.minus1 {
            color: #999;
        }
        .record-score.minus2 {
            color: #666;
        }
        .record-tag {
            font-size: 12px;
            background: #fdf2f5;
            color: #ff6b8b;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }
        .record-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }
        .record-reason {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .record-whisper {
            font-size: 14px;
            background: #fef6f9;
            padding: 8px;
            border-radius: 6px;
            color: #ff6b8b;
            cursor: pointer;
            position: relative;
        }
        .record-whisper::after {
            content: 'ç‚¹å‡»è§£é”æ‚„æ‚„è¯';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fef6f9;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
        }
        .record-whisper.unlock::after {
            display: none;
        }
        .empty {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }
        /* å¼¹çª—æ ·å¼-çºªå¿µæ—¥/æç¤º/åŒæ­¥ */
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            display: none;
        }
        .modal {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
        }
        .modal h4 {
            color: #ff6b8b;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-form-item {
            margin-bottom: 15px;
        }
        .modal-form-item label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 10px;
            font-size: 16px;
        }
        .modal-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .modal-confirm {
            background: #ff6b8b;
            color: #fff;
        }
        .modal-cancel {
            background: #eee;
            color: #666;
        }
        .sync-tip {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 15px;
            line-height: 1.5;
        }
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            border-radius: 3px;
            background: #ffc2d1;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        /* å“åº”å¼é€‚é… */
        @media (max-width: 480px) {
            .score-card {
                gap: 10px;
            }
            .avatar {
                width: 50px;
                height: 50px;
            }
            .score {
                font-size: 30px;
            }
            .btn-wrap {
                flex-direction: column;
            }
            .record-top-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter, .tag-filter {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å°ç™½&é¸¡æ¯› æ‹çˆ±åŠ å‡åˆ†å™¨ ğŸ’• åŒå‘å¥”èµ´</h1>

        <!-- åˆ†æ•°å±•ç¤ºåŒº-å¸¦å¤´åƒ+çºªå¿µæ—¥è§’æ ‡ -->
        <div class="score-card">
            <div class="person" id="girl">
                <div class="anniversary-tag" id="girl-anni-tag">çºªå¿µæ—¥</div>
                <img src="https://img.icons8.com/fluency/96/000000/girl.png" alt="å°ç™½" class="avatar" id="girl-avatar">
                <h2>å°ç™½</h2>
                <div class="score" id="girl-score">100</div>
            </div>
            <div class="person" id="boy">
                <div class="anniversary-tag" id="boy-anni-tag">çºªå¿µæ—¥</div>
                <img src="https://img.icons8.com/fluency/96/000000/boy.png" alt="é¸¡æ¯›" class="avatar" id="boy-avatar">
                <h2>é¸¡æ¯›</h2>
                <div class="score" id="boy-score">100</div>
            </div>
        </div>

        <!-- åŠ å‡åˆ†æ“ä½œåŒº-å…¨åŠŸèƒ½ -->
        <div class="operate">
            <h3>ä»Šæ—¥æ‹çˆ±æ“ä½œ</h3>
            <div class="form-item">
                <label>é€‰æ‹©æ“ä½œå¯¹è±¡</label>
                <select class="select-person" id="select-person">
                    <option value="">è¯·é€‰æ‹©è¦æ“ä½œçš„äºº</option>
                    <option value="boy">é¸¡æ¯›</option>
                    <option value="girl">å°ç™½</option>
                </select>
            </div>
            <div class="form-item">
                <label>é€‰æ‹©åˆ†æ•°å˜åŒ–</label>
                <div class="score-btn-group" id="score-btn-group">
                    <button class="score-btn" data-score="+1">+1 åˆ†</button>
                    <button class="score-btn" data-score="+2">+2 åˆ†</button>
                    <button class="score-btn" data-score="-1">-1 åˆ†</button>
                    <button class="score-btn" data-score="-2">-2 åˆ†</button>
                </div>
                <input type="hidden" id="current-score" value="">
            </div>
            <div class="form-item">
                <label>é€‰æ‹©ç”œèœœæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œå¯è‡ªå®šä¹‰ï¼‰</label>
                <select class="tag-select" id="tag-select">
                    <option value="æš–å¿ƒ">æš–å¿ƒ</option>
                    <option value="æŠ•å–‚">æŠ•å–‚</option>
                    <option value="æ’’å¨‡">æ’’å¨‡</option>
                    <option value="æƒ¹ç”Ÿæ°”">æƒ¹ç”Ÿæ°”</option>
                    <option value="æ•·è¡">æ•·è¡</option>
                    <option value="å¿˜è®°">å¿˜è®°</option>
                    <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰æ ‡ç­¾</option>
                </select>
                <input type="text" class="tag-input" id="tag-input" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾" style="display: none; width:100%; margin-top:8px; padding:10px; border:1px solid #eee; border-radius:8px; font-size:14px;">
            </div>
            <div class="form-item">
                <label>åŠ å‡åˆ†åŸå› ï¼ˆå¿…å¡«ï¼‰</label>
                <textarea class="reason" id="reason" placeholder="è¯´è¯´ä¸ºä»€ä¹ˆåŠ /æ‰£åˆ†å§ï½"></textarea>
            </div>
            <div class="form-item">
                <label>æ‚„æ‚„è¯ï¼ˆä»…å¯¹æ–¹å¯è§ï¼Œå¯é€‰ï¼‰</label>
                <textarea class="whisper" id="whisper" placeholder="å†™ä¸€å¥åªæœ‰å½¼æ­¤çŸ¥é“çš„å°ç§˜å¯†å§ï½"></textarea>
                <p class="tip">æ‚„æ‚„è¯åœ¨è®°å½•åŒºéœ€ç‚¹å‡»æ‰èƒ½æŸ¥çœ‹å“¦</p>
            </div>
            <div class="btn-wrap">
                <button class="confirm-btn" id="confirm-btn" disabled>ç¡®è®¤æ“ä½œ</button>
                <button class="export-btn" id="export-btn">å¯¼å‡ºè®°å½•</button>
                <button class="anniversary-btn" id="anniversary-btn">è®¾ç½®çºªå¿µæ—¥</button>
            </div>
        </div>

        <!-- åˆ†æ•°ç»Ÿè®¡åŒº -->
        <div class="stat">
            <h3>æ‹çˆ±åˆ†æ•°ç»Ÿè®¡</h3>
            <div class="stat-card">
                <div class="stat-item">
                    <p>å°ç™½ æ€»åŠ åˆ†</p>
                    <div class="stat-num" id="girl-add-total">0</div>
                </div>
                <div class="stat-item">
                    <p>å°ç™½ æ€»æ‰£åˆ†</p>
                    <div class="stat-num" id="girl-minus-total">0</div>
                </div>
                <div class="stat-item">
                    <p>å°ç™½ å‡€å¾—åˆ†</p>
                    <div class="stat-num" id="girl-net">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-item">
                    <p>é¸¡æ¯› æ€»åŠ åˆ†</p>
                    <div class="stat-num" id="boy-add-total">0</div>
                </div>
                <div class="stat-item">
                    <p>é¸¡æ¯› æ€»æ‰£åˆ†</p>
                    <div class="stat-num" id="boy-minus-total">0</div>
                </div>
                <div class="stat-item">
                    <p>é¸¡æ¯› å‡€å¾—åˆ†</p>
                    <div class="stat-num" id="boy-net">0</div>
                </div>
            </div>
        </div>

        <!-- åˆ†æ•°è¶‹åŠ¿å›¾åŒº -->
        <div class="trend">
            <h3>æ‹çˆ±åˆ†æ•°è¶‹åŠ¿</h3>
            <div class="chart-wrap">
                <canvas id="score-chart"></canvas>
            </div>
        </div>

        <!-- å†å²è®°å½•åŒº-å¤šç­›é€‰+æ‚„æ‚„è¯ -->
        <div class="record">
            <h3>æˆ‘ä»¬çš„æ‹çˆ±å°è®°</h3>
            <div class="record-top-bar">
                <div class="filter" id="person-filter">
                    <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-filter="girl">å°ç™½</button>
                    <button class="filter-btn" data-filter="boy">é¸¡æ¯›</button>
                </div>
                <div class="tag-filter" id="tag-filter">
                    <button class="filter-btn active" data-tag="all">æ‰€æœ‰æ ‡ç­¾</button>
                    <button class="filter-btn" data-tag="æš–å¿ƒ">æš–å¿ƒ</button>
                    <button class="filter-btn" data-tag="æŠ•å–‚">æŠ•å–‚</button>
                    <button class="filter-btn" data-tag="æ’’å¨‡">æ’’å¨‡</button>
                    <button class="filter-btn" data-tag="æƒ¹ç”Ÿæ°”">æƒ¹ç”Ÿæ°”</button>
                </div>
                <span class="record-count" id="record-count">å…±0æ¡</span>
                <button class="clear-btn" id="clear-btn">æ¸…ç©ºå°è®°</button>
            </div>
            <div class="record-list" id="record-list">
                <div class="empty">æš‚æ— æ‹çˆ±å°è®°ï¼Œå¿«æ¥æ·»åŠ ç¬¬ä¸€æ¡ç”œèœœç¬é—´å§ï½</div>
            </div>
        </div>
    </div>

    <!-- æç¤ºå¼¹çª— -->
    <div class="modal-mask" id="tip-modal">
        <div class="modal">
            <p id="tip-modal-text" style="text-align: center; font-size:16px; margin-bottom:20px;">æ“ä½œæˆåŠŸï¼</p>
            <button class="modal-btn modal-confirm" id="tip-modal-btn">ç¡®å®š</button>
        </div>
    </div>

    <!-- çºªå¿µæ—¥è®¾ç½®å¼¹çª— -->
    <div class="modal-mask" id="anni-modal">
        <div class="modal">
            <h4>è®¾ç½®ä¸“å±çºªå¿µæ—¥</h4>
            <div class="modal-form-item">
                <label>çºªå¿µæ—¥åç§°</label>
                <input type="text" class="modal-input" id="anni-name" placeholder="å¦‚ï¼šåœ¨ä¸€èµ·çºªå¿µæ—¥ã€ç”Ÿæ—¥">
            </div>
            <div class="modal-form-item">
                <label>çºªå¿µæ—¥æ—¥æœŸï¼ˆæœˆ/æ—¥ï¼‰</label>
                <input type="text" class="modal-input" id="anni-date" placeholder="å¦‚ï¼š05/20ã€12/31">
            </div>
            <div class="modal-btn-group">
                <button class="modal-btn modal-cancel" id="anni-cancel">å–æ¶ˆ</button>
                <button class="modal-btn modal-confirm" id="anni-save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åŒæ­¥æç¤ºå¼¹çª— -->
    <div class="modal-mask" id="sync-modal">
        <div class="modal">
            <h4>è·¨è®¾å¤‡åŒæ­¥æ•™ç¨‹</h4>
            <p style="font-size:14px; line-height:1.6; color:#666; margin-bottom:15px;">
                1. å°†æœ¬æ–‡ä»¶ä¿å­˜è‡³ã€ç™¾åº¦äº‘/è…¾è®¯å¾®äº‘/å¤¸å…‹äº‘ã€‘ç­‰äº‘ç›˜<br>
                2. ä½ å’Œé¸¡æ¯›å‡ä»äº‘ç›˜<b>ç”¨æµè§ˆå™¨æ‰“å¼€</b>è¯¥æ–‡ä»¶<br>
                3. æ“ä½œå‰åˆ·æ–°é¡µé¢ï¼Œæ“ä½œåè‡ªåŠ¨åŒæ­¥ï¼Œå®ç°å®æ—¶æ›´æ–°
            </p>
            <p class="sync-tip">ğŸ’¡ å°è´´å£«ï¼šæœ¬åœ°å­˜å‚¨+äº‘ç›˜åŒæ­¥ï¼Œæ•°æ®åŒé‡ä¿éšœï¼Œä¸ä¼šä¸¢å¤±ï½</p>
            <button class="modal-btn modal-confirm" id="sync-modal-btn">æˆ‘çŸ¥é“å•¦</button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å…¨å±€æ•°æ®
        let data = {
            girl: { score: 100, add: 0, minus: 0, trend: [100] },
            boy: { score: 100, add: 0, minus: 0, trend: [100] },
            record: [],
            anniversary: { name: '', date: '' },
            avatar: {
                girl: 'https://img.icons8.com/fluency/96/000000/girl.png',
                boy: 'https://img.icons8.com/fluency/96/000000/boy.png'
            },
            filter: { person: 'all', tag: 'all' },
            updateTime: new Date().toLocaleDateString()
        };
        let isClick = false; // é˜²æŠ–æ ‡è®°
        let chart = null; // è¶‹åŠ¿å›¾å®ä¾‹

        // è·å–æ‰€æœ‰DOMå…ƒç´ 
        const el = {
            // åˆ†æ•°å±•ç¤º
            girlScore: document.getElementById('girl-score'),
            boyScore: document.getElementById('boy-score'),
            girlAnniTag: document.getElementById('girl-anni-tag'),
            boyAnniTag: document.getElementById('boy-anni-tag'),
            girlAvatar: document.getElementById('girl-avatar'),
            boyAvatar: document.getElementById('boy-avatar'),
            // æ“ä½œåŒº
            selectPerson: document.getElementById('select-person'),
            scoreBtnGroup: document.getElementById('score-btn-group'),
            currentScore: document.getElementById('current-score'),
            tagSelect: document.getElementById('tag-select'),
            tagInput: document.getElementById('tag-input'),
            reason: document.getElementById('reason'),
            whisper: document.getElementById('whisper'),
            confirmBtn: document.getElementById('confirm-btn'),
            exportBtn: document.getElementById('export-btn'),
            anniversaryBtn: document.getElementById('anniversary-btn'),
            // ç»Ÿè®¡åŒº
            girlAddTotal: document.getElementById('girl-add-total'),
            girlMinusTotal: document.getElementById('girl-minus-total'),
            girlNet: document.getElementById('girl-net'),
            boyAddTotal: document.getElementById('boy-add-total'),
            boyMinusTotal: document.getElementById('boy-minus-total'),
            boyNet: document.getElementById('boy-net'),
            // è¶‹åŠ¿å›¾
            scoreChart: document.getElementById('score-chart'),
            // è®°å½•åŒº
            personFilter: document.getElementById('person-filter'),
            tagFilter: document.getElementById('tag-filter'),
            recordCount: document.getElementById('record-count'),
            clearBtn: document.getElementById('clear-btn'),
            recordList: document.getElementById('record-list'),
            // å¼¹çª—
            tipModal: document.getElementById('tip-modal'),
            tipModalText: document.getElementById('tip-modal-text'),
            tipModalBtn: document.getElementById('tip-modal-btn'),
            anniModal: document.getElementById('anni-modal'),
            anniName: document.getElementById('anni-name'),
            anniDate: document.getElementById('anni-date'),
            anniCancel: document.getElementById('anni-cancel'),
            anniSave: document.getElementById('anni-save'),
            syncModal: document.getElementById('sync-modal'),
            syncModalBtn: document.getElementById('sync-modal-btn')
        };

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            // è¯»å–æœ¬åœ°å­˜å‚¨æ•°æ®ï¼Œæ•°æ®æ ¡éªŒ
            const localData = localStorage.getItem('xbjm_loveScore');
            if (localData) {
                try {
                    const parseData = JSON.parse(localData);
                    if (parseData.girl && parseData.boy && Array.isArray(parseData.record)) {
                        data = { ...data, ...parseData };
                        // å¤´åƒåŒæ­¥
                        el.girlAvatar.src = data.avatar.girl;
                        el.boyAvatar.src = data.avatar.boy;
                    }
                } catch (e) {
                    showTipModal('æœ¬åœ°æ•°æ®å¼‚å¸¸ï¼Œä½¿ç”¨åˆå§‹æ•°æ®ï½');
                }
            }
            // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
            checkAnniversary(); // çºªå¿µæ—¥æ£€æµ‹
            updateScore();      // åˆ†æ•°æ›´æ–°
            updateStat();       // ç»Ÿè®¡æ›´æ–°
            initChart();        // è¶‹åŠ¿å›¾åˆå§‹åŒ–
            renderRecord();     // è®°å½•æ¸²æŸ“
            checkConfirmBtn();  // ç¡®è®¤æŒ‰é’®çŠ¶æ€
            // é¦–æ¬¡æ‰“å¼€æ˜¾ç¤ºåŒæ­¥æ•™ç¨‹
            if (!localStorage.getItem('xbjm_loveScore_tip')) {
                el.syncModal.style.display = 'flex';
                localStorage.setItem('xbjm_loveScore_tip', '1');
            }
        };

        // æ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä¸“å±keyï¼Œé¿å…å†²çªï¼‰
        function saveData() {
            localStorage.setItem('xbjm_loveScore', JSON.stringify(data));
        }

        // æç¤ºå¼¹çª—
        function showTipModal(text) {
            el.tipModalText.innerText = text;
            el.tipModal.style.display = 'flex';
        }
        // å¼¹çª—å…³é—­äº‹ä»¶
        el.tipModalBtn.onclick = () => el.tipModal.style.display = 'none';
        el.anniCancel.onclick = () => el.anniModal.style.display = 'none';
        el.syncModalBtn.onclick = () => el.syncModal.style.display = 'none';

        // 1. å¤´åƒæ›´æ¢ï¼ˆç‚¹å‡»å¤´åƒæ›¿æ¢ï¼Œæ”¯æŒç½‘ç»œå›¾ç‰‡/Base64ï¼‰
        el.girlAvatar.onclick = function() {
            const url = prompt('è¯·è¾“å…¥å°ç™½çš„å¤´åƒå›¾ç‰‡é“¾æ¥ï¼ˆç½‘ç»œå›¾ç‰‡/Base64ï¼‰ï¼š', data.avatar.girl);
            if (url) {
                this.src = url;
                data.avatar.girl = url;
                saveData();
            }
        };
        el.boyAvatar.onclick = function() {
            const url = prompt('è¯·è¾“å…¥é¸¡æ¯›çš„å¤´åƒå›¾ç‰‡é“¾æ¥ï¼ˆç½‘ç»œå›¾ç‰‡/Base64ï¼‰ï¼š', data.avatar.boy);
            if (url) {
                this.src = url;
                data.avatar.boy = url;
                saveData();
            }
        };

        // 2. è‡ªå®šä¹‰åŠ å‡åˆ†é€‰æ‹©
        el.scoreBtnGroup.addEventListener('click', function(e) {
            if (e.target.classList.contains('score-btn')) {
                this.querySelectorAll('.score-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                el.currentScore.value = e.target.dataset.score;
                checkConfirmBtn();
            }
        });

        // 3. ç”œèœœæ ‡ç­¾é€‰æ‹©ï¼ˆè‡ªå®šä¹‰æ ‡ç­¾æ˜¾ç¤º/éšè—ï¼‰
        el.tagSelect.onchange = function() {
            el.tagInput.style.display = this.value === 'è‡ªå®šä¹‰' ? 'block' : 'none';
        };

        // 4. æ£€æŸ¥ç¡®è®¤æŒ‰é’®æ˜¯å¦å¯ç‚¹å‡»
        function checkConfirmBtn() {
            const person = el.selectPerson.value;
            const score = el.currentScore.value;
            const reason = el.reason.value.trim();
            if (person && score && reason) {
                el.confirmBtn.classList.add('able');
                el.confirmBtn.disabled = false;
            } else {
                el.confirmBtn.classList.remove('able');
                el.confirmBtn.disabled = true;
            }
        }
        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œå®æ—¶æ£€æŸ¥
        el.selectPerson.onchange = checkConfirmBtn;
        el.reason.oninput = checkConfirmBtn;
        el.whisper.oninput = checkConfirmBtn;
        el.tagInput.oninput = checkConfirmBtn;

        // 5. ç¡®è®¤æ“ä½œï¼ˆé˜²æŠ–+æ ¸å¿ƒé€»è¾‘ï¼‰
        el.confirmBtn.onclick = function() {
            if (isClick) return;
            isClick = true;
            // è·å–æ“ä½œæ•°æ®
            const person = el.selectPerson.value;
            const scoreVal = el.currentScore.value;
            const scoreNum = Number(scoreVal);
            const tag = el.tagSelect.value === 'è‡ªå®šä¹‰' ? el.tagInput.value.trim() || 'æ— ' : el.tagSelect.value;
            const reason = el.reason.value.trim();
            const whisper = el.whisper.value.trim() || 'æ— æ‚„æ‚„è¯';
            const now = new Date();
            const time = now.toLocaleString('zh-CN');
            const date = now.toLocaleDateString();
            const isAnni = checkAnniversary(); // æ˜¯å¦æ˜¯çºªå¿µæ—¥

            // æ‰§è¡Œåˆ†æ•°æ›´æ–°
            data[person].score += scoreNum;
            // ç»Ÿè®¡æ€»åŠ åˆ†/æ€»æ‰£åˆ†
            if (scoreNum > 0) {
                data[person].add += Math.abs(scoreNum);
            } else {
                data[person].minus += Math.abs(scoreNum);
            }

            // è¶‹åŠ¿å›¾æ•°æ®æ›´æ–°ï¼ˆæ¯æ—¥ä»…ä¸€æ¡æ•°æ®ï¼‰
            if (data.updateTime !== date) {
                data.girl.trend.push(data.girl.score);
                data.boy.trend.push(data.boy.score);
                data.updateTime = date;
                // è¶‹åŠ¿å›¾æ•°æ®é™åˆ¶ï¼ˆæœ€å¤š30å¤©ï¼‰
                if (data.girl.trend.length > 30) {
                    data.girl.trend.shift();
                    data.boy.trend.shift();
                }
            } else {
                data.girl.trend[data.girl.trend.length - 1] = data.girl.score;
                data.boy.trend[data.boy.trend.length - 1] = data.boy.score;
            }

            // æ·»åŠ æ‹çˆ±è®°å½•
            const name = person === 'girl' ? 'å°ç™½' : 'é¸¡æ¯›';
            data.record.unshift({
                name,
                score: scoreVal,
                scoreType: scoreVal.includes('+') ? (scoreVal === '+1' ? 'add1' : 'add2') : (scoreVal === '-1' ? 'minus1' : 'minus2'),
                tag,
                reason,
                whisper,
                time,
                isAnni
            });

            // é¡µé¢æ›´æ–°+æ•°æ®ä¿å­˜
            setTimeout(() => {
                updateScore();
                updateStat();
                initChart();
                renderRecord();
                saveData();
                // é‡ç½®æ“ä½œåŒº
                el.selectPerson.value = '';
                el.scoreBtnGroup.querySelectorAll('.score-btn').forEach(btn => btn.classList.remove('active'));
                el.currentScore.value = '';
                el.tagSelect.value = 'æš–å¿ƒ';
                el.tagInput.style.display = 'none';
                el.tagInput.value = '';
                el.reason.value = '';
                el.whisper.value = '';
                checkConfirmBtn();
                showTipModal('æ“ä½œæˆåŠŸï¼ğŸ’• æ‹çˆ±å°è®°å·²æ·»åŠ ï½');
                isClick = false;
            }, 500);
        };

        // 6. çºªå¿µæ—¥è®¾ç½®ä¸æ£€æµ‹
        el.anniversaryBtn.onclick = () => {
            el.anniName.value = data.anniversary.name;
            el.anniDate.value = data.anniversary.date;
            el.anniModal.style.display = 'flex';
        };
        // ä¿å­˜çºªå¿µæ—¥
        el.anniSave.onclick = function() {
            const name = el.anniName.value.trim();
            const date = el.anniDate.value.trim();
            if (!name || !date) {
                showTipModal('è¯·å¡«å†™çºªå¿µæ—¥åç§°å’Œæ—¥æœŸï½');
                return;
            }
            data.anniversary = { name, date };
            saveData();
            el.anniModal.style.display = 'none';
            checkAnniversary();
            showTipModal(`ğŸ‰ ${name} è®¾ç½®æˆåŠŸï¼${date}å½“å¤©ä¼šæœ‰ç‰¹æ®Šæ ‡è®°ï½`);
        };
        // æ£€æµ‹æ˜¯å¦æ˜¯çºªå¿µæ—¥ï¼ˆæœˆ/æ—¥åŒ¹é…ï¼‰
        function checkAnniversary() {
            if (!data.anniversary.date) return false;
            const now = new Date();
            const nowMd = `${now.getMonth() + 1}/${now.getDate()}`;
            const isAnni = nowMd === data.anniversary.date;
            el.girlAnniTag.classList.toggle('show', isAnni);
            el.boyAnniTag.classList.toggle('show', isAnni);
            return isAnni;
        }

        // 7. è®°å½•å¯¼å‡ºä¸ºTXT
        el.exportBtn.onclick = function() {
            if (data.record.length === 0) {
                showTipModal('æš‚æ— æ‹çˆ±è®°å½•å¯å¯¼å‡ºï½');
                return;
            }
            // æ‹¼æ¥å¯¼å‡ºå†…å®¹
            let content = `âœ¨ å°ç™½&é¸¡æ¯›çš„æ‹çˆ±åŠ å‡åˆ†è®°å½• âœ¨\n\n`;
            content += `ğŸ“… å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n`;
            content += `â¤ï¸ å°ç™½å½“å‰åˆ†æ•°ï¼š${data.girl.score} åˆ†\n`;
            content += `â¤ï¸ é¸¡æ¯›å½“å‰åˆ†æ•°ï¼š${data.boy.score} åˆ†\n\n`;
            content += `==================== æ‹çˆ±å°è®° ====================\n\n`;
            data.record.forEach((item, index) => {
                content += `${index + 1}. ã€${item.name}ã€‘${item.score}åˆ† | æ ‡ç­¾ï¼š${item.tag}\n`;
                content += `æ—¶é—´ï¼š${item.time} | çºªå¿µæ—¥ï¼š${item.isAnni ? 'æ˜¯' : 'å¦'}\n`;
                content += `åŸå› ï¼š${item.reason}\n`;
                content += `æ‚„æ‚„è¯ï¼š${item.whisper}\n\n`;
            });
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `å°ç™½&é¸¡æ¯›çš„æ‹çˆ±è®°å½•_${new Date().toLocaleDateString()}.txt`;
            a.click();
            URL.revokeObjectURL(a.href);
            showTipModal('æ‹çˆ±è®°å½•å¯¼å‡ºæˆåŠŸï¼ğŸ’• å·²ä¿å­˜è‡³æœ¬åœ°ï½');
        };

        // 8. åˆ†æ•°è¶‹åŠ¿å›¾åˆå§‹åŒ–/æ›´æ–°
        function initChart() {
            // é”€æ¯åŸæœ‰å®ä¾‹
            if (chart) chart.destroy();
            // ç”Ÿæˆxè½´æ ‡ç­¾ï¼ˆè¿‘Nå¤©ï¼‰
            const xLabels = data.girl.trend.map((_, i) => i === 0 ? 'åˆå§‹' : `ç¬¬${i}å¤©`);
            // åˆ›å»ºå›¾è¡¨
            chart = new Chart(el.scoreChart, {
                type: 'line',
                data: {
                    labels: xLabels,
                    datasets: [
                        {
                            label: 'å°ç™½çš„åˆ†æ•°',
                            data: data.girl.trend,
                            borderColor: '#ff6b8b',
                            backgroundColor: 'rgba(255,107,139,0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#ff6b8b'
                        },
                        {
                            label: 'é¸¡æ¯›çš„åˆ†æ•°',
                            data: data.boy.trend,
                            borderColor: '#4285F4',
                            backgroundColor: 'rgba(66,133,244,0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#4285F4'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.min(...data.girl.trend, ...data.boy.trend) - 5,
                            ticks: { stepSize: 5 }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { size: 14 } }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // 9. è®°å½•ç­›é€‰ï¼ˆäººç‰©+æ ‡ç­¾ï¼‰
        // äººç‰©ç­›é€‰
        el.personFilter.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-btn')) {
                this.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                data.filter.person = e.target.dataset.filter;
                renderRecord();
            }
        });
        // æ ‡ç­¾ç­›é€‰
        el.tagFilter.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-btn')) {
                this.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                data.filter.tag = e.target.dataset.tag;
                renderRecord();
            }
        });

        // 10. æ¸²æŸ“æ‹çˆ±è®°å½•
        function renderRecord() {
            // ç­›é€‰æ•°æ®
            let filterRecord = [...data.record];
            // äººç‰©ç­›é€‰
            if (data.filter.person !== 'all') {
                const name = data.filter.person === 'girl' ? 'å°ç™½' : 'é¸¡æ¯›';
                filterRecord = filterRecord.filter(item => item.name === name);
            }
            // æ ‡ç­¾ç­›é€‰
            if (data.filter.tag !== 'all') {
                filterRecord = filterRecord.filter(item => item.tag === data.filter.tag);
            }
            // æ›´æ–°è®°å½•æ¡æ•°
            el.recordCount.innerText = `å…±${filterRecord.length}æ¡`;
            // æ¸…ç©ºåˆ—è¡¨
            el.recordList.innerHTML = '';
            // æ— è®°å½•
            if (filterRecord.length === 0) {
                el.recordList.innerHTML = '<div class="empty">æš‚æ— ç›¸å…³æ‹çˆ±å°è®°ï½</div>';
                return;
            }
            // æ¸²æŸ“æ¯æ¡è®°å½•
            filterRecord.forEach(item => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <div class="record-anni-tag ${item.isAnni ? 'show' : ''}"></div>
                    <div class="record-top">
                        <span class="record-name">${item.name}<span class="record-tag">${item.tag}</span></span>
                        <span class="record-score ${item.scoreType}">${item.score}</span>
                    </div>
                    <div class="record-time">${item.time}</div>
                    <div class="record-reason">${item.reason}</div>
                    <div class="record-whisper">${item.whisper}</div>
                `;
                // æ‚„æ‚„è¯è§£é”ç‚¹å‡»äº‹ä»¶
                div.querySelector('.record-whisper').onclick = function() {
                    this.classList.toggle('unlock');
                };
                el.recordList.appendChild(div);
            });
        }

        // 11. æ¸…ç©ºæ‹çˆ±è®°å½•ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰
        el.clearBtn.onclick = function() {
            if (data.record.length === 0) {
                showTipModal('æš‚æ— è®°å½•å¯æ¸…ç©ºï½');
                return;
            }
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‹çˆ±å°è®°å—ï¼Ÿæ“ä½œä¸å¯æ¢å¤å“¦ï½')) {
                data.record = [];
                saveData();
                renderRecord();
                showTipModal('æ‹çˆ±å°è®°å·²æ¸…ç©ºï½');
            }
        };

        // 12. æ›´æ–°å®æ—¶åˆ†æ•°ï¼ˆå«é¢œè‰²æé†’ï¼‰
        function updateScore() {
            // å°ç™½åˆ†æ•°
            el.girlScore.innerText = data.girl.score;
            el.girlScore.className = 'score';
            if (data.girl.score < 90) el.girlScore.classList.add('low');
            if (data.girl.score < 80) el.girlScore.classList.add('very-low');
            // é¸¡æ¯›åˆ†æ•°
            el.boyScore.innerText = data.boy.score;
            el.boyScore.className = 'score';
            if (data.boy.score < 90) el.boyScore.classList.add('low');
            if (data.boy.score < 80) el.boyScore.classList.add('very-low');
        }

        // 13. æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStat() {
            el.girlAddTotal.innerText = data.girl.add;
            el.girlMinusTotal.innerText = data.girl.minus;
            el.girlNet.innerText = data.girl.add - data.girl.minus;
            el.boyAddTotal.innerText = data.boy.add;
            el.boyMinusTotal.innerText = data.boy.minus;
            el.boyNet.innerText = data.boy.add - data.boy.minus;
        }
    </script>
</body>
</html>